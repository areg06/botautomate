<!DOCTYPE html>
<html lang="en" class="h-full">
  <head>
    <meta charset="UTF-8" />
    <title>Trading Bot Dashboard</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <style>
      body { font-feature-settings: "cv11","ss01"; }
      .log-line {
        white-space: pre;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      }
    </style>
  </head>
  <body class="h-full bg-slate-950 text-slate-100">
    <div class="min-h-full flex justify-center py-8 px-4">
      <div class="w-full max-w-6xl space-y-4">
        <!-- Header -->
        <div class="flex flex-col sm:flex-row sm:items-baseline sm:justify-between gap-2">
          <div>
            <h1 class="text-xl font-semibold text-slate-50">ðŸ¤– Trading Bot Dashboard</h1>
            <p class="text-xs text-slate-400">
              Status, recent signals, trades, realized profits, and live logs.
            </p>
          </div>
          <div
            class="inline-flex items-center gap-2 rounded-full px-3 py-1 text-xs font-medium
                   bg-emerald-500/10 text-emerald-300 ring-1 ring-emerald-500/40"
          >
            <span class="h-2 w-2 rounded-full bg-emerald-400 animate-pulse"></span>
            <span id="mode-pill">Mode: {{ 'DRY RUN' if mode == 'DRY RUN' else 'LIVE' }}</span>
          </div>
        </div>

        <!-- Summary cards -->
        <div class="grid grid-cols-1 md:grid-cols-5 gap-3">
          <div class="rounded-lg bg-slate-900/70 border border-slate-800 px-3 py-2">
            <p class="text-[10px] uppercase tracking-[0.18em] text-slate-500 mb-1">Channel</p>
            <p id="summary-channel" class="text-xs font-medium truncate">{{ channel_id }}</p>
          </div>
          <div class="rounded-lg bg-slate-900/70 border border-slate-800 px-3 py-2">
            <p class="text-[10px] uppercase tracking-[0.18em] text-slate-500 mb-1">Last Signal</p>
            <p id="summary-signal" class="text-xs font-medium text-slate-100 truncate">-</p>
          </div>
          <div class="rounded-lg bg-slate-900/70 border border-slate-800 px-3 py-2">
            <p class="text-[10px] uppercase tracking-[0.18em] text-slate-500 mb-1">Last Trade</p>
            <p id="summary-trade" class="text-xs font-medium text-slate-100 truncate">-</p>
          </div>
          <div class="rounded-lg bg-slate-900/70 border border-slate-800 px-3 py-2">
            <p class="text-[10px] uppercase tracking-[0.18em] text-slate-500 mb-1">Last TP / Profit</p>
            <p id="summary-tp" class="text-xs font-medium text-emerald-400 truncate">-</p>
          </div>
          <div class="rounded-lg bg-slate-900/70 border border-rose-900/60 px-3 py-2">
            <p class="text-[10px] uppercase tracking-[0.18em] text-slate-500 mb-1">Last Error</p>
            <p id="summary-error" class="text-xs font-medium text-rose-400 truncate">-</p>
          </div>
        </div>

        <!-- Second row: overview + logs -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
          <!-- Overview -->
          <section class="lg:col-span-1 rounded-xl bg-slate-900/70 border border-slate-800 p-4">
            <h2 class="text-sm font-semibold text-slate-100 mb-2">Behavior Overview</h2>
            <ul class="list-disc list-inside text-xs text-slate-300 space-y-1">
              <li>Monitors a Telegram channel for trading signals (Long / Short).</li>
              <li>Uses <span class="font-semibold text-emerald-300">15% of balance</span> per trade.</li>
              <li>Executes market entries on Binance USDT-M futures.</li>
              <li>Sets stop loss at <span class="font-semibold text-rose-300">âˆ’170% ROI</span> (leverage-adjusted).</li>
              <li>Closes <span class="font-semibold text-emerald-300">100% of position</span> at Target #1 (single TP).</li>
              <li>Tracks active trades and realized TP profits.</li>
              <li>Optionally sends Telegram notifications to a private chat.</li>
            </ul>
            <p class="mt-3 text-[11px] text-slate-500">
              Tip: Use the log filters on the right to focus on signals &amp; trades or only errors.
            </p>
            <div class="mt-4 text-[11px] text-slate-500">
              <p>Uptime: <span id="summary-uptime" class="font-mono">{{ uptime }}</span></p>
            </div>
          </section>

          <!-- Live logs -->
          <section class="lg:col-span-2 rounded-xl bg-slate-900/70 border border-slate-800 p-4">
            <div class="flex items-center gap-2 mb-3">
              <h2 class="text-sm font-semibold text-slate-100">Live Logs</h2>
              <span class="ml-2 inline-flex items-center rounded-full bg-slate-800 px-2 py-0.5 text-[10px] text-slate-400">
                SSE Â· 1s stream
              </span>
              <div class="ml-auto flex items-center gap-2 text-[11px]">
                <button
                  id="filter-all"
                  class="px-2 py-0.5 rounded border border-slate-700 bg-slate-800 text-slate-100 text-[11px] filter-btn"
                >
                  All
                </button>
                <button
                  id="filter-signal_trade"
                  class="px-2 py-0.5 rounded border border-slate-700 bg-slate-900 text-slate-300 text-[11px] filter-btn"
                >
                  Signals &amp; Trades
                </button>
                <button
                  id="filter-error"
                  class="px-2 py-0.5 rounded border border-slate-700 bg-rose-950 text-rose-300 text-[11px] filter-btn"
                >
                  Errors
                </button>
              </div>
            </div>

            <div
              id="logs"
              class="logs-container h-80 overflow-y-auto rounded-lg border border-slate-800 bg-slate-950/90 px-3 py-2"
            >
              <div class="log-line text-xs text-slate-500">Waiting for eventsâ€¦</div>
            </div>
          </section>
        </div>
      </div>
    </div>

    <script>
      const stateUrl = "/api/state";
      const logStreamUrl = "/logs/stream";
      let currentFilter = "all";

      function summarizeState(data) {
        if (data.last_signal) {
          const s = data.last_signal;
          document.getElementById("summary-signal").textContent =
            `${s.symbol} Â· ${s.direction} Â· ${new Date(s.ts).toLocaleTimeString()}`;
        }

        if (data.last_trade) {
          const t = data.last_trade;
          document.getElementById("summary-trade").textContent =
            `${t.symbol} Â· ${t.direction} Â· ${t.entry_price} Â· qty ${Number(t.qty).toFixed(3)}`;
        }

        if (data.last_tp) {
          const tp = data.last_tp;
          document.getElementById("summary-tp").textContent =
            `${tp.symbol} Â· ${Number(tp.roi_pct).toFixed(1)}% Â· ${new Date(tp.ts).toLocaleTimeString()}`;
        }

        if (data.last_error) {
          document.getElementById("summary-error").textContent = data.last_error.message;
        }

        if (data.uptime) {
          document.getElementById("summary-uptime").textContent = data.uptime;
        }
      }

      async function pollState() {
        try {
          const resp = await fetch(stateUrl);
          const data = await resp.json();
          summarizeState(data);
        } catch (e) {
          console.error("state error", e);
        } finally {
          setTimeout(pollState, 5000);
        }
      }

      function createLogLine(log) {
        const div = document.createElement("div");
        div.className = "log-line text-xs";
        const level = (log.level || "INFO").toUpperCase();
        const tag = log.tag || "";
        const msg = log.message || "";

        let colorClass = "text-slate-200";
        if (level === "ERROR") colorClass = "text-rose-400";
        else if (tag === "TP" || msg.includes("Target #1 achieved")) colorClass = "text-emerald-300";
        else if (tag === "SIGNAL") colorClass = "text-sky-300";
        div.classList.add(...colorClass.split(" "));

        div.dataset.type =
          tag === "SIGNAL"
            ? "signal"
            : tag === "TRADE"
            ? "trade"
            : tag === "TP"
            ? "tp"
            : level === "ERROR"
            ? "error"
            : "info";

        const ts = new Date(log.ts || Date.now()).toLocaleTimeString();
        div.textContent = `[${ts}] [${level}] [${tag}] ${msg}`;
        return div;
      }

      function shouldShowLine(line) {
        const t = line.dataset.type || "info";
        if (currentFilter === "all") return true;
        if (currentFilter === "error") return t === "error";
        if (currentFilter === "signal_trade") return t === "signal" || t === "trade";
        return true;
      }

      function setupFilters() {
        const map = {
          all: document.getElementById("filter-all"),
          signal_trade: document.getElementById("filter-signal_trade"),
          error: document.getElementById("filter-error"),
        };
        Object.entries(map).forEach(([name, btn]) => {
          btn.addEventListener("click", () => {
            currentFilter = name;
            Object.values(map).forEach((b) =>
              b.classList.remove("border-emerald-500", "bg-emerald-500/20", "text-emerald-200")
            );
            btn.classList.add("border-emerald-500", "bg-emerald-500/20", "text-emerald-200");
            const container = document.getElementById("logs");
            Array.from(container.children).forEach((child) => {
              child.style.display = shouldShowLine(child) ? "" : "none";
            });
          });
        });
      }

      function startLogStream() {
        const evtSource = new EventSource(logStreamUrl);
        const container = document.getElementById("logs");
        container.innerHTML = "";

        evtSource.onmessage = (event) => {
          try {
            const log = JSON.parse(event.data);
            const line = createLogLine(log);
            line.style.display = shouldShowLine(line) ? "" : "none";
            container.appendChild(line);
            container.scrollTop = container.scrollHeight;
          } catch (e) {
            console.error("log parse error", e);
          }
        };

        evtSource.onerror = (err) => {
          console.error("SSE error", err);
        };
      }

      document.addEventListener("DOMContentLoaded", () => {
        setupFilters();
        pollState();
        startLogStream();
      });
    </script>
  </body>
</html>

